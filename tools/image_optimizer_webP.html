<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to WebP Converter</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a nice, clean font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-button {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: #4f46e5;
            color: white;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .file-input-button:hover {
            background-color: #4338ca;
        }
        .result-row {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        /* Styles for the preview modal */
        #previewModal.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-gray-800 bg-opacity-50 rounded-2xl shadow-2xl p-6 md:p-8 backdrop-blur-sm border border-gray-700">
        
        <!-- Header Section (Minimized) -->
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">
                Image to WebP Converter
            </h1>
        </div>

        <!-- Controls Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center bg-gray-900 p-4 rounded-lg border border-gray-700">
            <!-- File Upload -->
            <div class="flex items-center gap-4">
                <input type="file" id="imageInput" multiple accept="image/jpeg, image/png, image/gif, image/bmp, image/tiff" class="hidden">
                <label for="imageInput" class="file-input-button flex-shrink-0">Select Images</label>
                <p id="file-info" class="text-gray-500 text-sm truncate">No files selected.</p>
            </div>

            <!-- Quality and Rerun -->
            <div class="flex items-center space-x-3">
                <div class="flex-grow">
                    <label for="qualitySlider" class="sr-only">Conversion Quality</label>
                    <input id="qualitySlider" type="range" min="0.1" max="1.0" value="0.9" step="0.05" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <span id="qualityValue" class="font-mono text-indigo-400 bg-gray-700 px-2 py-1 rounded-md text-sm">0.90</span>
                <button id="rerunButton" disabled class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors">
                    Rerun
                </button>
            </div>
        </div>

        <!-- Output Section -->
        <div id="output" class="mt-6">
            <div id="status" class="text-center text-gray-400 mb-4"></div>
            <!-- Results Table -->
            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table id="results-table" class="min-w-full text-left text-sm hidden">
                    <thead class="bg-gray-900 text-xs text-gray-300 uppercase tracking-wider">
                        <tr>
                            <th scope="col" class="px-6 py-3">Filename</th>
                            <th scope="col" class="px-6 py-3 text-right">Original Size</th>
                            <th scope="col" class="px-6 py-3 text-right">WebP Size</th>
                            <th scope="col" class="px-6 py-3 text-right">Savings</th>
                            <th scope="col" class="px-6 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="results-body" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Rows will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-6xl max-h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-white">Image Quality Comparison</h2>
                <button id="closeModal" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <p class="text-center text-gray-400 text-sm mb-4">Move your mouse over an image to zoom in and compare details.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Original Image Preview with Zoom -->
                <div>
                    <h3 class="text-lg font-semibold text-center text-gray-300 mb-2">Original</h3>
                    <div id="originalPreviewWrapper" class="overflow-hidden rounded-md bg-gray-700 aspect-video cursor-crosshair">
                        <img id="originalPreview" src="" alt="Original Image" class="max-w-none transition-transform duration-100 ease-linear" style="transform-origin: top left;">
                    </div>
                </div>
                <!-- WebP Image Preview with Zoom -->
                <div>
                    <h3 class="text-lg font-semibold text-center text-gray-300 mb-2">WebP (Preview)</h3>
                    <div id="webpPreviewWrapper" class="overflow-hidden rounded-md bg-gray-700 aspect-video cursor-crosshair">
                        <img id="webpPreview" src="" alt="WebP Preview" class="max-w-none transition-transform duration-100 ease-linear" style="transform-origin: top left;">
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // DOM element references
        const imageInput = document.getElementById('imageInput');
        const statusDiv = document.getElementById('status');
        const fileInfo = document.getElementById('file-info');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const rerunButton = document.getElementById('rerunButton');
        const resultsTable = document.getElementById('results-table');
        const resultsBody = document.getElementById('results-body');
        const previewModal = document.getElementById('previewModal');
        const closeModal = document.getElementById('closeModal');
        const originalPreview = document.getElementById('originalPreview');
        const webpPreview = document.getElementById('webpPreview');
        const originalPreviewWrapper = document.getElementById('originalPreviewWrapper');
        const webpPreviewWrapper = document.getElementById('webpPreviewWrapper');

        // State variables
        let currentFiles = [];

        // Event Listeners
        imageInput.addEventListener('change', handleImageSelection);
        rerunButton.addEventListener('click', () => {
            if (currentFiles.length > 0) processFiles(currentFiles);
        });
        qualitySlider.addEventListener('input', () => {
             qualityValue.textContent = parseFloat(qualitySlider.value).toFixed(2);
        });
        closeModal.addEventListener('click', () => previewModal.classList.add('hidden'));
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) previewModal.classList.add('hidden');
        });

        // Event delegation for preview buttons
        resultsBody.addEventListener('click', (e) => {
            const previewButton = e.target.closest('.preview-btn');
            if (previewButton) {
                const originalSrc = previewButton.dataset.originalSrc;
                const webpSrc = previewButton.dataset.webpSrc;
                originalPreview.src = originalSrc;
                webpPreview.src = webpSrc;
                previewModal.classList.remove('hidden');
                // Reset any previous transforms when opening
                resetPan();
            }
        });

        // --- ZOOM/PAN LOGIC ---
        function syncPan(e) {
            const wrapper = e.currentTarget;
            const img = wrapper.querySelector('img');

            // Do nothing if the image hasn't loaded its natural dimensions yet
            if (!img.naturalWidth) return;
            
            // No need to pan if image is smaller than the container
            if (img.naturalWidth <= wrapper.clientWidth && img.naturalHeight <= wrapper.clientHeight) {
                resetPan();
                return;
            }

            const rect = wrapper.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const xPercent = x / wrapper.clientWidth;
            const yPercent = y / wrapper.clientHeight;

            const xOverflow = img.naturalWidth - wrapper.clientWidth;
            const yOverflow = img.naturalHeight - wrapper.clientHeight;

            const translateX = -xOverflow * xPercent;
            const translateY = -yOverflow * yPercent;

            originalPreview.style.transform = `translate(${translateX}px, ${translateY}px)`;
            webpPreview.style.transform = `translate(${translateX}px, ${translateY}px)`;
        }

        function resetPan() {
            originalPreview.style.transform = 'translate(0px, 0px)';
            webpPreview.style.transform = 'translate(0px, 0px)';
        }

        // Attach listeners to both preview wrappers
        originalPreviewWrapper.addEventListener('mousemove', syncPan);
        webpPreviewWrapper.addEventListener('mousemove', syncPan);
        originalPreviewWrapper.addEventListener('mouseleave', resetPan);
        webpPreviewWrapper.addEventListener('mouseleave', resetPan);
        // --- END ZOOM/PAN LOGIC ---


        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function handleImageSelection(event) {
            currentFiles = Array.from(event.target.files);
            if (currentFiles.length === 0) {
                fileInfo.textContent = 'No files selected.';
                rerunButton.disabled = true;
                statusDiv.innerHTML = '';
                resultsBody.innerHTML = '';
                resultsTable.classList.add('hidden');
                return;
            }
            fileInfo.textContent = `${currentFiles.length} file(s) selected.`;
            rerunButton.disabled = false;
            processFiles(currentFiles);
        }

        function processFiles(files) {
            statusDiv.innerHTML = `<p class="text-indigo-400">Processing ${files.length} image(s)...</p>`;
            resultsBody.innerHTML = '';
            resultsTable.classList.add('hidden');
            let processedCount = 0;

            files.forEach((file, index) => {
                if (!file.type.startsWith('image/')) {
                    console.warn(`Skipping non-image file: ${file.name}`);
                    processedCount++;
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    const originalSrc = e.target.result;
                    img.onload = async () => {
                        await convertToWebP(img, file, originalSrc, index);
                        processedCount++;
                        if (processedCount === files.length) {
                             statusDiv.innerHTML = `<p class="text-green-400">Conversion complete! Results are below.</p>`;
                        }
                    };
                    img.src = originalSrc;
                };
                reader.readAsDataURL(file);
            });
        }

        async function convertToWebP(img, originalFile, originalSrc, index) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            const quality = parseFloat(qualitySlider.value);
            const webpDataUrl = canvas.toDataURL('image/webp', quality);

            const webpBlob = await (await fetch(webpDataUrl)).blob();
            const newSize = webpBlob.size;
            const originalSize = originalFile.size;
            const savings = 100 - (newSize / originalSize) * 100;

            const baseName = originalFile.name.split('.').slice(0, -1).join('.');
            const newFilename = `${baseName}.webp`;

            addResultRow(newFilename, originalSize, newSize, savings, originalSrc, webpDataUrl, index);
        }

        function addResultRow(filename, originalSize, newSize, savings, originalSrc, webpDataUrl, index) {
            if (resultsTable.classList.contains('hidden')) {
                resultsTable.classList.remove('hidden');
            }
            const row = document.createElement('tr');
            row.className = 'result-row';
            const savingsColor = savings >= 0 ? 'text-green-400' : 'text-red-400';
            const savingsSign = savings >= 0 ? '' : '+';

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-200">${filename}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-gray-400">${formatBytes(originalSize)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-gray-400">${formatBytes(newSize)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right font-semibold ${savingsColor}">${savingsSign}${savings.toFixed(1)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <button 
                            class="preview-btn p-2 text-gray-400 hover:text-white transition-colors" 
                            title="Preview"
                            data-original-src="${originalSrc}" 
                            data-webp-src="${webpDataUrl}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <a href="${webpDataUrl}" download="${filename}" class="p-2 text-gray-400 hover:text-white transition-colors" title="Download">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        </a>
                    </div>
                </td>
            `;
            
            resultsBody.appendChild(row);

            setTimeout(() => {
                row.style.opacity = '1';
                row.style.transform = 'translateY(0)';
            }, 50 * index);
        }
    </script>
</body>
</html>
